name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.test.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        id: test
        run: npm run test:run
        continue-on-error: true

  ai-review:
    name: AI Code Review
    runs-on: self-hosted  # Uses your homelab runner with Claude Code
    needs: test
    if: needs.test.outputs.tests_passed == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > /tmp/pr-diff.patch
          echo "Files changed:"
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}

      - name: Run Claude Code Review
        id: review
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the review prompt
          cat > /tmp/review-prompt.md << 'PROMPT_EOF'
          Review this pull request and provide feedback.

          ## PR Info
          - Title: ${{ github.event.pull_request.title }}
          - Author: ${{ github.event.pull_request.user.login }}
          - Description: ${{ github.event.pull_request.body }}

          ## Task
          Analyze the code changes and provide:
          1. **Summary**: Brief overview of the changes
          2. **Test Coverage**: Are new features adequately tested?
          3. **Code Quality**: Any code smells or improvements?
          4. **Potential Issues**: Bugs, edge cases, security concerns?
          5. **Suggestions**: Constructive improvements

          Be concise and constructive. Focus on significant issues, not style nitpicks.

          Output your review as markdown suitable for a GitHub PR comment.
          PROMPT_EOF

          # Run Claude Code with the diff
          cd ${{ github.workspace }}

          # Use Claude Code to review (--print outputs to stdout, -p for prompt)
          claude --print -p "$(cat /tmp/review-prompt.md)

          Here is the diff to review:

          $(cat /tmp/pr-diff.patch | head -c 50000)" > /tmp/review-output.md

          echo "Review generated"

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review-output.md', 'utf8');

            const body = `## ü§ñ AI Code Review

            ${review}

            ---
            *Reviewed by Claude Code on self-hosted runner*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  skip-review:
    name: Skip AI Review (Tests Failed)
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.outputs.tests_passed != 'true'
    steps:
      - name: Post skip comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚è≠Ô∏è **AI Review Skipped**\n\nTests failed. Please fix failing tests before AI review runs.'
            })
