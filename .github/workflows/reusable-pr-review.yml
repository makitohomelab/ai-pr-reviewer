name: Reusable AI PR Review

on:
  workflow_call:
    inputs:
      ollama_model:
        description: 'Ollama model for code review'
        type: string
        default: 'qwen2.5-coder:32b'
      pipeline_mode:
        description: 'Pipeline mode: sequential or parallel'
        type: string
        default: 'parallel'
      agent_token_budget:
        description: 'Token budget per agent'
        type: string
        default: '16384'
    secrets:
      GITHUB_TOKEN:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-origin:
    name: Check PR Origin
    runs-on: ubuntu-latest
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
    steps:
      - id: check
        run: |
          if [ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "::notice::PR is from a fork - security review will be skipped"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi

  ai-review:
    name: AI Code Review
    runs-on: [self-hosted, claude-code]
    needs: check-origin
    if: needs.check-origin.outputs.is_fork != 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout ai-pr-reviewer
        uses: actions/checkout@v4
        with:
          repository: makitohomelab/ai-pr-reviewer
          path: ai-pr-reviewer

      - name: Wake Desktop for Ollama
        run: ~/scripts/wake-desktop.sh

      - name: Verify Ollama Available
        env:
          OLLAMA_BASE_URL: ${{ vars.OLLAMA_BASE_URL || 'http://localhost:11434' }}
        run: |
          for i in {1..10}; do
            if curl -s --connect-timeout 5 "$OLLAMA_BASE_URL/api/tags"; then
              exit 0
            fi
            sleep 5
          done
          echo "Ollama not responding after wake" && exit 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install and build ai-pr-reviewer
        working-directory: ai-pr-reviewer
        run: npm ci && npm run build

      - name: Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL_PROVIDER: ollama
          OLLAMA_BASE_URL: ${{ vars.OLLAMA_BASE_URL || 'http://localhost:11434' }}
          OLLAMA_MODEL: ${{ inputs.ollama_model }}
          OLLAMA_CODE_REVIEW_MODEL: ${{ inputs.ollama_model }}
          OLLAMA_SECURITY_MODEL: ${{ inputs.ollama_model }}
          AGENT_TOKEN_BUDGET: ${{ inputs.agent_token_budget }}
          PIPELINE_MODE: ${{ inputs.pipeline_mode }}
          REPO_MANAGER_SYNC: "false"
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          DEBUG_AI_REVIEW: "true"
        run: node ai-pr-reviewer/dist/index.js

  skip-fork-review:
    name: Skip Review (Fork PR)
    runs-on: ubuntu-latest
    needs: check-origin
    if: needs.check-origin.outputs.is_fork == 'true'
    steps:
      - name: Post skip comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '⏭️ **AI Review Skipped**\n\nThis PR is from a fork. For security reasons, AI review only runs on PRs from the main repository.'
            })
